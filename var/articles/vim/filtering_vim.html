.. vim:set expandtab ff=unix ft=rest :

..  Quich Filter : 軽快動作で使いやすい検索結果一覧表示プラグイン

..  filtering.vimは、軽快に動作する、使いやすい検索プラグインです。
    カレントバッファを指定キーワードでフィルタリングし、その結果の一覧を見やすく表示する機能があります。
    (Windows, Mac)

.. |BR| raw:: html

    <br />

.. |yen|    unicode:: U+000A5 .. YEN SIGN

.. role:: raw-html(raw)
    :format: html

.. contents::

================================================================================
概要
================================================================================

Quich Filter : Quickly filter all matches of a string, browse the list, and jump back quickly. |BR|
http://www.vim.org/scripts/script.php?script_id=2759

filtering.vimは、軽快に動作する、使いやすい検索プラグインです。 |BR|
カレントバッファを指定キーワードでフィルタリングし、その結果の一覧を見やすく表示する機能があります。

.. image:: /dist/img/vim/filtering_vim.png
    :alt:  filtering.vim



================================================================================
インストール方法
================================================================================

`vim.orgで配布されているプラグインファイル`__ をダウンロードして入手後、 |BR|
pluginディレクトリにダウンロードしたファイル「filtering.vim」をコピーしてください。

__ http://www.vim.org/scripts/script.php?script_id=2759

.. csv-table::
    :header: "ファイル", "URL"

    "filtering.vim", "http://www.vim.org/scripts/script.php?script_id=2759"



================================================================================
filtering.vimプラグインの使い方
================================================================================

filtering.vimプラグインの操作には、2つの段階があります。 |BR|
検索を行うまでの操作、通常のVimエディタウィンドウ内での操作と、 |BR|
検索後、フィルタリング結果表示ウィンドウ上での操作です。

.. image:: /dist/img/vim/filtering_vim_flow.png
    :alt:  操作の流れ


通常のウィンドウでの操作（検索実行に関わるものが中心）
-------------------------------------------------------------------------------

検索用に用意されているコマンドは
:raw-html:`<kbd>,f</kbd>` と、 :raw-html:`<kbd>,F</kbd>` の2つです。

一度検索を実行した後、ノーマルモードで :raw-html:`<kbd>,f</kbd>` を入力すると、 |BR|
*最後に検索したキーワード* でカレントバッファをフィルタリングし、マッチした行を別ウィンドウに結果を表示します。

.. image:: /dist/img/vim/filtering_vim_sf.png
    :alt:  結果を別ウィンドウで表示

|BR|
新規に検索を行う場合は、ノーマルモードで :raw-html:`<kbd>,F</kbd>` を押下すれば、入力プロンプトが表示されるので、 |BR|
その入力プロンプトで検索ワードを入力してください。

.. image:: /dist/img/vim/filtering_vim_lf.png
    :alt:  新規フィルタリング開始

.. csv-table:: 通常ウィンドウでの操作
    :header: "コマンド", "説明"

    ",f" , "最後に検索したキーワードでカレントバッファをフィルタリングし、結果を別ウィンドウに表示します。"
    ",F" , "入力プロンプトを表示し、入力されたキーワードでのフィルタリングを実行します。"
    ",g" , "フィルタリング結果ウィンドウが開かれていれば、そのウィンドウにカーソルを移動します。"


フィルタリング結果ウィンドウでの操作（検索結果参照に関わるものが中心）
-------------------------------------------------------------------------------

フィルタリング結果ウィンドウでは、先のキーワード検索の結果の表示と、|BR|
検索結果位置へのカーソル移動ができます。

いくつかの操作コマンドが用意されていますが、基本的には、 |BR|
・ :raw-html:`<kbd>Enter</kbd>` キーで検索結果位置に移動、 |BR|
・ :raw-html:`<kbd>Shift-Enter</kbd>` キーで検索結果位置に移動 ＋ 検索結果ウィンドウを閉じる、 |BR|
という動作になると、覚えておけば良いでしょう。

.. csv-table:: フィルタリング結果ウィンドウでの操作
    :header: "コマンド", "説明"

    "<Enter>" , 選択したフィルタリング結果の位置にカーソルを移動します。フィルタリング結果ウィンドウは閉じない。
    "<S-Enter>" , 選択したフィルタリング結果の位置にカーソルを移動します。フィルタリング結果ウィンドウは、カーソル移動後、閉じられます。
    "o" , 選択したフィルタリング結果を表示します。カーソルはフィルタリング結果ウィンドウ上から移動しません。
    "a" , トグルオプションです。押下する度にON/OFFと機能が切り替わります。ONにすると、フィルタリング結果ウィンドウ上でカーソル移動時、元のウィンドウの表示も検索位置に切り替えます。
    "c" , 後の :raw-html:`<kbd>C</kbd>` と対になるコマンドです。フィルタリング結果ウィンドウで表示する、検索結果前後の表示行数を増やします。デフォルト0行です。
    "C" , :raw-html:`<kbd>c</kbd>` と対になるコマンドです。フィルタリング結果ウィンドウで表示する、検索結果前後の表示行数を減らします。
    "j" , フィルタリング結果ウィンドウで、カーソルを下に動かします。
    "k" , フィルタリング結果ウィンドウで、カーソルを上に動かします。

|BR|
少し変わっているのは、 :raw-html:`<kbd>c</kbd>` コマンド、 :raw-html:`<kbd>C</kbd>` コマンドで、 |BR|
これらのキーを押下すると、検索結果行 前後の表示テキストの行数を変えられます。 |BR|
下画像（↓）は、前後2行を表示している様子です。

.. image:: /dist/img/vim/filtering_vim_expand.png
    :alt:  前後行表示



================================================================================
プラグインの機能の拡張
================================================================================

ところで、このfiltering.vimプラグイン、 |BR|
:raw-html:`<kbd>,f</kbd>` による検索では、最後に検索したキーワードを対象に検索を行いますし、 |BR|
:raw-html:`<kbd>,F</kbd>` による検索では、検索キーワードの入力が必要になるので、 |BR|
新規に検索を行う場合は、少々使いづらいところがあるように思います。

そこで少しだけ工夫をしてみましょう。 |BR|
次の行を、Vimエディタの設定ファイルに追加してみてください。

.. parsed-literal::
    :class: console

    **" filtering.vimの機能を利用。カーソル下文字の検索**
    nmap ,r :call Gather(expand("<cword>"), 0)<CR>:echo<CR>

このように設定すると、
ノーマルモードで :raw-html:`<kbd>,r</kbd>` を押下した時に、カーソル下のキーワードを対象に、 |BR|
filtering.vimプラグインの検索を実行できるようになります。

.. note::

    filtering.vimはカレントバッファを対象に検索を行うが、
    多数のファイルを対象に検索を行いたい場合はどうするか。 |BR|
    ユーザーインターフェイスは違うが、そういう場合は、 :raw-html:`<kbd>:vimgrep</kbd>` コマンドを利用すると良い。



