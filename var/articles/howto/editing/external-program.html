.. vim:set expandtab ff=unix ft=rest :

..  vimエディタから外部のプログラムやコマンドを実行する。

..  この記事では、vimエディタから外部のプログラムを実行する方法、
    そして、vimエディタで外部プログラムの実行結果を受け取って編集作業に役立てる方法を紹介します。
    外部のプログラムを利用できるようになると、vimエディタでできる事が格段に広がります。
    (Windows, Mac)

.. |BR| raw:: html

    <br />

.. |yen| unicode:: U+000A5 .. YEN SIGN

.. role:: raw-html(raw)
    :format: html

.. contents::

================================================================================
概要
================================================================================

この記事では、vimエディタから外部のプログラムを実行する方法、 |BR|
そして、vimエディタで外部プログラムの実行結果を受け取って編集作業に役立てる方法を紹介します。 |BR|
外部のプログラムを利用できるようになると、vimエディタでできる事が格段に広がります。



================================================================================
「!」による外部プログラムの実行
================================================================================

外部プログラムの単純な実行
-------------------------------------------------------------------------------

最も簡単に外部プログラムを実行する方法は、exモードで :raw-html:`<kbd>!</kbd>` を使用することです。 |BR|
次のようにコマンドを入力すると、 :raw-html:`<kbd>!</kbd>` の後に入力した外部プログラムが実行されます。

.. parsed-literal::
    :class: console

    :! {外部プログラム}

.. parsed-literal::
    :class: console

    **" ディレクトリのファイル一覧を確認（Mac OSX環境のみ）**
    :!ls
    
    **" 時間を確認（Windows環境のみ）**
    :!date /T
    
    **" 不要なファイルを削除（Windows環境のみ）**
    :!del log.txt
    
    **" 編集中のファイルをCVSレポジトリにコミット**
    :!cvs ci -m "" %

.. image:: /dist/img/howto/editing/run_external_cmd_onwin.jpg
    :alt:  Windows環境での外部プログラムの実行

↑Windows環境では別ウィンドウ、↓Mac OSX環境では同じウィンドウ内で実行されます。

.. image:: /dist/img/howto/editing/run_external_cmd_onmac.png
    :alt:  Mac OSX環境での外部プログラムの実行

.. note::

    vimエディタのコマンドの中で「%」を使用すると、 |BR|
    コマンド実行時に、「%」は今開いているファイルのパスと置き換わります。


実行した外部プログラムの結果の読み取り
-------------------------------------------------------------------------------

:raw-html:`<kbd>:r</kbd>` コマンドを外部プログラム実行用の :raw-html:`<kbd>!</kbd>` と組み合わせると、外部プログラムの実行結果を読み取ることができます。 |BR|
次のようにコマンドを実行すると、外部プログラムが実行された後、プログラムの実行結果がコマンド実行時のカーソルの位置に書き込まれます。

.. parsed-literal::
    :class: console

    :r ! {外部プログラム}

.. parsed-literal::
    :class: console

    **" カーソルの位置に、日付を書き込む**
    :r! date /T

.. image:: /dist/img/howto/editing/read_external_cmd.jpg
    :alt:  コマンド入力

↓（外部コマンドの実行結果がファイルに書き込まれる）

.. image:: /dist/img/howto/editing/read_external_cmd_result.jpg
    :alt:  プログラムの実行結果がカーソル位置に書き込まれる


外部コマンドをフィルターとして使用する。
-------------------------------------------------------------------------------

範囲を指定してから、 :raw-html:`<kbd>!</kbd>` で外部プログラムを実行すると、 |BR|
選択した範囲のテキストに外部プログラムを実行してから、その実行結果で選択範囲のテキストを置き換える、という  |BR|
外部プログラムのフィルター的な使い方が出来ます。

.. parsed-literal::
    :class: console

    :'<,'>:! {外部プログラム}
    :2,50! {外部プログラム}

.. parsed-literal::
    :class: console

    **" 選択範囲に行番号をつける**
    '<,'>:!cat -n
    
    **" 15から40行目に「native2ascii -reverse」コマンドを実行する**
    :15,40!native2ascii -reverse

.. image:: /dist/img/howto/editing/select_external_cmd_target.jpg
    :alt:  範囲選択

↓（コマンドを実行すると、選択範囲が外部コマンドの実行結果で置き換わる）

.. image:: /dist/img/howto/editing/select_external_cmd_result.jpg
    :alt:  行番号の付与



================================================================================
外部プログラムの実行結果の即展開
================================================================================

使用できる状況はかなり限定されますが、 |BR|
vimエディタのコマンドの引数で「\`{外部プログラム}\`」の書式を使用すると、 |BR|
外部プログラムの実行結果を即座に展開して、コマンドの引数として、プログラム実行結果を利用できます。

.. parsed-literal::
    :class: console

    :e \`{外部プログラム}\`

.. parsed-literal::
    :class: console

    **" echoコマンドの結果文字列をファイル名として使用する**
    :e \`echo test.txt\`
    
    **" rand_filename.shスクリプトの実行結果を、書き込み先のファイル名として使用する**
    :w \`rand_filename.sh\`

.. note::

    正直使い道はあまり考え付きません。 |BR|
    ファイル名などをプログラム的に決めたいが、vimスクリプトではどう書くかわからない時などに、 |BR|
    perl、rubyなどの得意な言語でファイル名を決定したりすることはできます。



================================================================================
シェルを起動して、そのシェルで外部のプログラムを実行
================================================================================

シェルを起動して、そのシェル上で外部のプログラムを実行することもできるでしょう。 |BR|
vimエディタ上でシェルを起動するには次のコマンドを実行します。

.. parsed-literal::
    :class: console

    :sh

.. image:: /dist/img/howto/editing/sh_on_winvim.jpg
    :alt:  Windows環境で「sh」コマンドを実行する

↑Windows環境では別ウィンドウ、↓Mac OSX環境では同じウィンドウ内で実行されます。

.. image:: /dist/img/howto/editing/sh_on_macvim.png
    :alt:  Mac OSX環境で「sh」コマンドを実行する

この場合、シェルを起動すると、そのシェルに制御が移りますが、 |BR|
シェルを終了すると、vimエディタに制御が戻ります。


vimエディタと、「:sh」コマンドで起動したシェルの間で、データをやり取りするには
-------------------------------------------------------------------------------

:raw-html:`<kbd>:sh</kbd>` コマンドで起動したシェルと、vimエディタの間でデータのやり取りをするには、 |BR|
・作業ファイルを用意してファイルを経由して結果を受け渡しするか、 |BR|
・システムのクリップボードを使用すると良いでしょう。

クリップボードを使用してデータをやり取りするなら、 |BR|
Windowsのcygwin環境なら「getclip」「putclip」コマンド、 |BR|
Mac OSX環境なら「pbcopy」「pbpaste」コマンドが役に立つかもしれません。

.. csv-table::
    :header: 環境, クリップボードからの出力, クリップボードへの入力

    Cygwin環境, putclip, getclip
    Mac OSX環境, pbpaste, pbcopy




