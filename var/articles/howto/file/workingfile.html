.. vim:set expandtab ff=unix ft=rest :

..  一時ファイル、作業用ファイルを使い倒すための実戦向けテクニック

..  設定ファイルを編集したり、コーディングすることだけが、Vimエディタの使い道ではありません。
    Vimエディタに備わっている高い編集能力は、他の雑多な作業においても十分に役に立つものがあります。
    このページでは、それら小作業において多用されることの多い、
    一時ファイル、作業用ファイル、メモ用ファイルをより活用する術をご紹介します。
    コーディングの共に、議事録のメモに、計算処理の結果算出にと、役立つ場面の多い技術です。
    (Windows, Mac)

.. |BR| raw:: html

    <br />

.. |yen| unicode:: U+000A5 .. YEN SIGN

.. role:: raw-html(raw)
    :format: html

.. contents::

================================================================================
概要
================================================================================

設定ファイルを編集したり、コーディングすることだけが、Vimエディタの使い道ではありません。 |BR|
Vimエディタに備わっている高い編集能力は、他の雑多な作業においても十分に役に立つものがあります。

このページでは、それら小作業において多用されることの多い、 |BR|
一時ファイル、作業用ファイル、メモ用ファイルをより活用する術をご紹介します。

コーディングの共に、議事録のメモに、計算処理の結果算出にと、役立つ場面の多い技術です。



================================================================================
無名バッファを作業用領域として利用する
================================================================================

新規にVimエディタを立ち上げるか、 :raw-html:`<kbd>:enew</kbd>` コマンドで空のバッファを作り、
そのバッファを作業用の領域として利用します。

最も簡単に作業用の領域を用意できる方法ではありますが、
Vimエディタを終了してしまえば編集していた情報は消滅してしまいますし、
一部プラグインの機能の利用やバッファの切り替えなどで、不都合が生じることもあります。

しかし、いくらかの簡易な作業は、無名バッファでも十分なはずです。


無名バッファの作り方
--------------------------------------------------------------------------------

新規にVimエディタを立ち上げるか、起動中のVimエディタから無名バッファを作るコマンドを実行する。

.. parsed-literal::
    :class: console

    **" 新たに無名バッファを開く**
    :enew

    **" ウィンドウを分割して、そこに無名バッファを開く**
    :split +enew
    :vsplit +enew

    **" 新しいタブを作り、そこで無名バッファを開く**
    :tabnew


無名ファイルのクラッシュ時のリカバリー方法
--------------------------------------------------------------------------------

万が一、無名ファイルで作業中にVimエディタがクラッシュしてしまった場合でも、 |BR|
.swp、.swoという名前のスワップファイルを探して、そのファイルに対して :raw-html:`<kbd>:recover</kbd>` コマンドを実行すれば、 |BR|
クラッシュ前の状態までリカバリできます。いざというときは、このリカバリー方法を思い出しましょう。 [#]_

.. parsed-literal::
    :class: console

    **" スワップファイルからリカバリ**
    :recover .swp


作業終了後の無名ファイルの閉じ方
--------------------------------------------------------------------------------

無名バッファでの作業終了後は、
:raw-html:`<kbd>ZQ</kbd>` コマンドや :raw-html:`<kbd>:bd!</kbd>` コマンドでバッファを閉じます。 |BR|
（ :raw-html:`<kbd>ZQ</kbd>` コマンドは編集中のバッファの状態を保存せずにバッファを閉じられるコマンド。）

:raw-html:`<kbd>ZQ</kbd>` コマンドは通常編集作業では、
編集結果を保存せずにバッファを閉じてしまう可能性のある危険性の高いコマンドですが、
一時ファイルや作業用ファイルを活用する場合は多用することになります。



================================================================================
スクラッチバッファを作業用領域として利用する
================================================================================

スクラッチバッファは作業のために領域として使うのに向いている。
簡単な作業であれば、多くの場合、非常に利用しやすい。


スクラッチバッファの作り方
--------------------------------------------------------------------------------

Vimエディタでスクラッチバッファを利用するには、

- Kaoriya版Vimエディタに含まれる、 :raw-html:`<kbd>:Scratch</kbd>` コマンド [#]_ を使うか、
- Vim公式サイトで配布されている `スクラッチバッファ管理系プラグイン`__ [#]_ をインストールする、

__ http://www.vim.org/script.php?script_id=389

と良い。

多くのスクラッチバッファ管理系プラグインでは、一度、スクラッチバッファを閉じてしまうと、
閉じる前の情報は消失していまい、復元できない。注意して利用してほしい。



================================================================================
一時ファイルを作業用領域として利用する
================================================================================

一時ファイルを作成し、そのファイルを作業用ファイルとして利用します。 |BR|
この方法ではファイルシステム上にファイルが実際に存在するので、
作成したファイルを対象に外部コマンドなども実行できます。 [#]_
これは一時ファイルを作業用領域として使う場合の、大きな利点の一つです。


一時ファイルの作り方
--------------------------------------------------------------------------------

一時ファイルは、Vimエディタの一時ファイル作成機能を利用して作り出せば良いでしょう。 |BR|
この時作成した一時ファイルは、Vimエディタ終了時に削除されます（ということになっている）。

一時ファイルは、削除されるまでは他のアプリケーションからも利用できるし、
別のファイルで作業後に開き直すこともできます。

.. parsed-literal::
    :class: console

    **" 一時ファイルを作成して、開く**
    :edit \`=tempname()\`

上記コマンドを実行すると、例えば、次のような名前のファイルが開かれます。 |BR|
どのような名前のファイルが開かれるかは、貴方のVimエディタの実行環境次第です。

.. parsed-literal::
    :class: program

    /var/folders/F0/F0evLcz0Giymvy+P9VHaJ++++TM/-Tmp-/v982233/0


一時ファイル作成用のコマンドを用意する
--------------------------------------------------------------------------------

一時ファイル作成を多用する場合は専用のコマンドを用意しておくと、一時ファイル作成の手間を省けます。

コマンド定義の例を挙げる。 |BR|
この設定をVimエディタの設定ファイルに追加すると、
:raw-html:`<kbd>:OpenTempfile</kbd>` コマンドで一時ファイルを開けるようになります。

.. parsed-literal::
    :class: program

    **" 一時ファイルを作成して開く、OpenTempfileコマンドを定義**
    :command! OpenTempfile :edit \`=tempname()\`


利用していた一時ファイルを後から探す
--------------------------------------------------------------------------------

他のファイルでの作業を行った後、一時ファイルを再び開く場合は、 |BR|
作業していた一時ファイルのファイル名を思い出すのは大抵の場合、困難なので、

- `mru.vim`__ [#]_
- `fuzzyfinder.vim`__ [#]_

__ /articles/vim/mru_vim.html
__ http://www.vim.org/scripts/script.php?script_id=1984

などの、過去に開いたファイルを記録できるプラグインを使って、ファイルを探すと良い。



================================================================================
実ファイルを作業用領域として利用する
================================================================================

明示的に「todo.txt」や「meeting-20091112.txt」のようなファイル名を指定してファイル作成し、 |BR|
そのファイルを作業用の領域として利用します。
数日間、数週間など、ある程度の期間、情報をキープしたい時に向いています。

ただし、実ファイルを作業ファイルとして利用する場合は、 |BR|
そのファイルが必要なくなった時に、自分で後始末、削除しなければなりません。


日付入りファイル
--------------------------------------------------------------------------------

ファイル名に日付を入れておけば、利用した日付ごとにファイルを整理できるので、
後日、情報を再利用しやすくなります。

日付入りのファイルを作成する方法はいくつかありますが、 |BR|
このページでは、Vimエディタの設定ファイルであらかじめ日付変数を設定しておいて、その変数をファイル名の一部として使用する、
という、入門者にも簡単に利用、応用できる方法を紹介します。


日付入りファイルの作り方
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Vimエディタの設定ファイルで「$TODAY」変数を定義しておいて、

.. parsed-literal::
    :class: program

    **" 今日の日付を「$TODAY」に入れておく。Vimエディタ起動時に設定される。**
    :let $TODAY = strftime('%Y%m%d')

ファイルを開くときにファイル名の一部として「$TODAY」を指定します。

.. parsed-literal::
    :class: console

    **" 作業日の日付の入ったファイルを作る**
    :edit ~/Desktop/meeting-$TODAY.txt
    
    " #=> :edit ~/Desktop/meeting-20091112.txt
    " $TODAYが日付に展開される。


連番入りファイル
--------------------------------------------------------------------------------

データ変換用のファイルなど同じ用途で複数のファイルが必要な場合は、連番ファイルを使用すると良いでしょう。 |BR|
筆者の作成した `コマンドライン行数値インクリメントデクリメントプラグイン`__ [#]_ が役に立つかもしれない。

__ http://indefero.taku-o.net/index.php/p/download/source/file/master/cmdline-increment.vim


多数の連番入りファイルの作り方
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

一度に多数の連番入りの作業ファイルが必要な場合は、
Vimエディタからではなくシェルから作ります。

全ての環境での方法を紹介することはとてもできないため、 |BR|
ここではWindows PowerShell環境と、Unix bash環境での、連番入りファイルの作り方の例を紹介します。 |BR|
下コードは、ファイルにいったん書いてから実行しても良いが、シェルに直接入力しても実行できる。

.. parsed-literal::
    :class: console

    **# Windows PowerShell 連番ファイルの作り方**
    **# template.txtを複製して、連番ファイルを作成する**
    for ($i = 1; $i -le 10; $i ++ )
    {
        cp template.txt work-$i.txt
    }

.. parsed-literal::
    :class: console

    **# bash 連番ファイルの作り方**
    **# template.txtを複製して、連番ファイルを作成する**
    for i in {1..10}
    do
        cp template.txt work-$i.txt
    done



================================================================================
既存のファイルを作業用ファイルのテンプレートとして使う
================================================================================

テスト用コードの作成、似たような文面の文章の作成などで、 |BR|
既に存在する既存ファイルをベースにして、作業用ファイルを作りたい時もあるでしょう。

覚えておくと便利なコマンドをいくつか紹介します。

.. parsed-literal::
    :class: console

    **" 他のファイルを読み込み、カーソル位置に流し込む**
    :read filename

    **" テンプレートにしたいファイルを開いている状態で、**
    **" そのファイルを他のファイルに書き込んで、即開く。**
    :saveas filename

:raw-html:`<kbd>:read</kbd>` コマンドは一度に一つのファイルしか読み込めない。 |BR|
多数のファイルを一度に読みたい場合は、筆者作 `rargs.vimプラグイン`__ [#]_ が役に立つ。

__ http://indefero.taku-o.net/index.php/p/download/source/file/master/rargs.vim

.. parsed-literal::
    :class: console

    **" カーソル位置に、指定した複数のファイルの内容を流し込む。**
    :RArgs \*.cs \*.java \*.pl



================================================================================
作業用ファイルを直接実行する
================================================================================

作業ファイルが実行可能なプログラムのコードである場合、
作業後に、そのファイルを確認のため、あるいは新たな成果物を出力するため、「実行したい」という事は良くあることだと思います。

- Vimスクリプトファイルであれば、 `batch.vim`__ [#]_ を、
- Perl、Python、Ruby、シェルスクリプト辺りであれば、 `quickrun.vim`__ [#]_ を使えば、

__ /articles/vim/batch_vim.html
__ http://www.vim.org/scripts/download_script.php?src_id=10552

編集中の作業ファイルを実行できます。



================================================================================
目次ファイルからのリンク
================================================================================

何度も何度も後から開き直す事になる場合は、ファイルパスの一覧ファイルを作成しておくと、 |BR|
ファイル名の上で :raw-html:`<kbd>gf</kbd>` を押下して、そのファイルまで移動できる。

.. parsed-literal::
    :class: program

    **# このようなファイル名一覧を用意しておいて、移動したいファイル名の上でgfを押下する。**
    crash-recovery.html
    file-dialog.html
    open-lastfile.html
    seemingly-unneeded-file.html
    workingfile.html

|BR|
ファイル名の一覧は、外部コマンドを利用して作成しても良いし、

.. parsed-literal::
    :class: console

    **" lsコマンドを使用してファイル一覧を読み込む**
    :read !ls

`lsf.vimプラグイン`__ [#]_ を使用して作成しても良い。

__ /articles/vim/lsf_vim.html

.. parsed-literal::
    :class: console

    **" カーソル位置にファイル一覧を読み込む**
    :LSF



================================================================================
ファイルタイプを設定する
================================================================================

一時ファイル、作業用ファイルであっても、ファイルタイプは設定できます。

最も簡単なファイルタイプの設定方法は、
作業用ファイルの拡張子を利用したいファイルタイプ用の拡張子にしてしまうことですが、
短期間の利用であれば、直接コマンドでファイルタイプを設定しても良いし、

.. parsed-literal::
    :class: console

    **" memoファイルタイプを指定する（Kaoriyaパッチ）**
    :setlocal filetype=memo

ある程度の期間の利用が見込まれるのであれば、モードラインを設定しても良いでしょう。 [#]_

.. parsed-literal::
    :class: program

    **" シェルスクリプトであれば、このようなモードラインをファイルに設定する**
    # vim:set filetype=memo :



================================================================================
参考情報リンクなど
================================================================================

外部のページへのリンクが多かったので、まとめてあります。

.. [#] `swapファイルが見つかった場合にどのように対処すべきか（クラッシュからのリカバリー）`__
.. [#] `cmdex.vim : Kaoriyaパッチ ユーティリティコマンド集`__
.. [#] `scratch utility : 自由に開閉できる作業用バッファ管理プラグイン`__
.. [#] `vimエディタから外部のプログラムやコマンドを実行する。`__
.. [#] `mru.vim : 開いたファイルの履歴を管理して、最近開いたファイルに簡単にアクセスできるようにするプラグイン`__
.. [#] `FuzzyFinder : buffer/file/command/tag/etc explorer with fuzzy matching`__
.. [#] `cmdline-increment.vim : コマンドライン行で数値インクリメント、デクリメント`__
.. [#] `rargs.vim : 指定した複数のファイルを一度に読み込む`__
.. [#] `batch.vim : 選択した範囲に記述されたvimスクリプトを実行する`__
.. [#] `quickrun - run a command and show its result quickly`__
.. [#] `lsf.vim : カレントディレクトリ以下のファイル、ディレクトリ一覧を読み込む`__
.. [#] `モードラインを使って、ファイルごとにvimエディタのオプションを指定する。`__

__ /articles/howto/file/crash-recovery.html
__ /articles/vim/cmdex_vim.html
__ /articles/vim/scratch_vim.html
__ /articles/howto/editing/external-program.html
__ /articles/vim/mru_vim.html
__ http://www.vim.org/scripts/script.php?script_id=1984
__ http://indefero.taku-o.net/index.php/p/download/source/file/master/cmdline-increment.vim
__ /articles/vim/rargs_vim.html
__ /articles/vim/batch_vim.html
__ http://www.vim.org/scripts/download_script.php?src_id=10552
__ /articles/vim/lsf_vim.html
__ /articles/howto/file/modeline.html



